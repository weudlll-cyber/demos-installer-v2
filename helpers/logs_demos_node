#!/bin/bash
# Unified helper script for inspecting and repairing the Demos Node systemd service.
# Supports: --status, --logs=N, --health, --autorestart, --restart
set -u
IFS=$'\n\t'

SERVICE_NAME="demos-node"
UNIT_NAME="${SERVICE_NAME}.service"

# === Determine HTTP endpoint dynamically from .env ===
ENV_PATH="/opt/demos-node/.env"
NODE_PORT=53550
BASE_URL="http://127.0.0.1:$NODE_PORT"

_trim_trailing() {
  local s="$1"
  s="${s%/}"    # remove trailing slash
  s="${s%:}"    # remove trailing colon
  # trim surrounding whitespace
  s="$(printf "%s" "$s" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
  printf '%s' "$s"
}

# load and normalise .env values if present
if [ -f "$ENV_PATH" ]; then
  NODE_PORT=$(grep -m1 "^NODE_PORT=" "$ENV_PATH" | cut -d'=' -f2 || echo "53550")
  # fallback if empty
  NODE_PORT=${NODE_PORT:-53550}

  EXPOSED_URL=$(grep -m1 "^EXPOSED_URL=" "$ENV_PATH" | cut -d'=' -f2 || true)
  EXPOSED_IP=$(grep -m1 "^EXPOSED_IP=" "$ENV_PATH" | cut -d'=' -f2 || true)

  EXPOSED_URL=${EXPOSED_URL:-}
  EXPOSED_IP=${EXPOSED_IP:-}

  if [ -n "$EXPOSED_URL" ]; then
    # ensure scheme present
    if [[ "$EXPOSED_URL" != http://* && "$EXPOSED_URL" != https://* ]]; then
      EXPOSED_URL="http://$EXPOSED_URL"
    fi

    base="$(_trim_trailing "$EXPOSED_URL")"

    # remove scheme for port-detection
    hostport="${base#http://}"
    hostport="${hostport#https://}"

    # if hostport already ends with :<digits> assume a port exists
    if [[ "$hostport" =~ :[0-9]+$ ]]; then
      BASE_URL="$base"
    else
      BASE_URL="${base}:$NODE_PORT"
    fi

  elif [ -n "$EXPOSED_IP" ]; then
    ip="$(_trim_trailing "$EXPOSED_IP")"
    if [[ "$ip" == *:* ]]; then
      BASE_URL="http://[$ip]:$NODE_PORT"
    else
      BASE_URL="http://$ip:$NODE_PORT"
    fi
  else
    BASE_URL="http://127.0.0.1:$NODE_PORT"
  fi
fi

# ensure single trailing slash behavior and final endpoint
BASE_URL="${BASE_URL%/}"
HTTP_ENDPOINT="${BASE_URL}/health"

# === Systemd & journalctl checks ===
if ! command -v systemctl &>/dev/null; then
  echo -e "\e[91m‚ùå systemctl not found. This system may not support systemd.\e[0m"
  exit 1
fi
if ! command -v journalctl &>/dev/null; then
  echo -e "\e[91m‚ùå journalctl not found. Cannot display logs.\e[0m"
  exit 1
fi
if ! systemctl show "$UNIT_NAME" &>/dev/null; then
  echo -e "\e[91m‚ùå Service $UNIT_NAME not found.\e[0m"
  echo -e "\e[91mMake sure the node was installed and the service was created.\e[0m"
  echo -e "\e[91mTry:\e[0m"
  echo -e "\e[91msudo systemctl daemon-reload && sudo systemctl enable $UNIT_NAME && sudo systemctl start $UNIT_NAME\e[0m"
  exit 1
fi

# === Functions ===
restart_node() {
  echo -e "\e[91müîÑ Delegating restart to restart_demos_node helper...\e[0m"
  if command -v restart_demos_node &>/dev/null; then
    sudo restart_demos_node && echo -e "\e[91m‚úÖ restart_demos_node completed.\e[0m" || {
      echo -e "\e[91m‚ùå restart_demos_node failed. Try manually:\e[0m"
      echo -e "\e[91msudo restart_demos_node --force\e[0m"
      exit 1
    }
  elif [ -x "/opt/demos-node/helpers/restart_demos_node" ]; then
    sudo /opt/demos-node/helpers/restart_demos_node && echo -e "\e[91m‚úÖ restart script completed.\e[0m" || {
      echo -e "\e[91m‚ùå restart script failed. Try manually:\e[0m"
      echo -e "\e[91msudo /opt/demos-node/helpers/restart_demos_node --force\e[0m"
      exit 1
    }
  else
    echo -e "\e[91m‚ùå restart_demos_node helper not found. Falling back to systemctl restart.\e[0m"
    systemctl restart "$UNIT_NAME" && echo -e "\e[91m‚úÖ Restart successful.\e[0m" || {
      echo -e "\e[91m‚ùå Restart failed. Try manually:\e[0m"
      echo -e "\e[91msudo systemctl restart $UNIT_NAME\e[0m"
      exit 1
    }
  fi
}

check_health() {
  echo -e "\e[91müîç Performing detailed health check...\e[0m"
  STATUS=$(systemctl is-active "$UNIT_NAME")
  PID=$(systemctl show -p MainPID "$UNIT_NAME" | cut -d= -f2 || echo 0)
  PID=${PID:-0}

  echo -e "\e[91müß† Systemd Status: $STATUS\e[0m"
  case "$STATUS" in
    active) echo -e "\e[91m‚úÖ Service is running normally.\e[0m" ;;
    inactive) echo -e "\e[91m‚ö†Ô∏è Service is installed but not running. Attempting auto-repair...\e[0m"; restart_node ;;
    failed) echo -e "\e[91m‚ùå Service has crashed. Attempting auto-repair...\e[0m"; restart_node ;;
    activating) echo -e "\e[91m‚è≥ Service is starting. Wait a moment and recheck.\e[0m" ;;
    deactivating) echo -e "\e[91m‚è∏Ô∏è Service is shutting down.\e[0m" ;;
    *) echo -e "\e[91m‚ùì Unknown status: $STATUS\e[0m" ;;
  esac

  if [[ "$PID" =~ ^[0-9]+$ ]] && [ "$PID" -gt 0 ]; then
    echo -e "\e[91müß¨ Main PID: $PID (process is alive)\e[0m"
  else
    echo -e "\e[91m‚ö†Ô∏è No active process found.\e[0m"
  fi

  echo -e "\e[91müåê Checking HTTP endpoint: $HTTP_ENDPOINT\e[0m" >&2
  # debug: print endpoint before probing (helps catch malformed URLs)
  echo -e "\e[90mDEBUG: HTTP_ENDPOINT='$HTTP_ENDPOINT'\e[0m" >&2

  if curl -fs "$HTTP_ENDPOINT" &>/dev/null; then
    echo -e "\e[91m‚úÖ HTTP endpoint is responsive.\e[0m"
  else
    echo -e "\e[91m‚ö†Ô∏è HTTP endpoint is not responding. Attempting auto-repair...\e[0m"
    restart_node
    sleep 2
    if curl -fs "$HTTP_ENDPOINT" &>/dev/null; then
      echo -e "\e[91m‚úÖ HTTP endpoint recovered.\e[0m"
    else
      echo -e "\e[91m‚ùå Still unresponsive. Check node config or logs:\e[0m"
      echo -e "\e[91msudo journalctl -u $UNIT_NAME --no-pager --since \"10 minutes ago\"\e[0m"
    fi
  fi
}

# === Main ===
COMMAND="${1:---status}"

case "$COMMAND" in
  --status)
    STATUS=$(systemctl is-active "$UNIT_NAME")
    PID=$(systemctl show -p MainPID "$UNIT_NAME" | cut -d= -f2 || echo 0)
    PID=${PID:-0}
    echo -e "\e[91müîç Status: $STATUS\e[0m"
    echo -e "\e[91müß¨ PID: $PID\e[0m"
    ;;

  --logs=*)
    COUNT="${COMMAND#--logs=}"
    echo -e "\e[91müìú Showing last $COUNT lines of logs...\e[0m"
    journalctl -u "$UNIT_NAME" --no-pager -n "$COUNT"
    ;;

  --health)
    check_health
    ;;

  --autorestart)
    echo -e "\e[91müîç Checking health before auto-restart...\e[0m"
    if curl -fs "$HTTP_ENDPOINT" &>/dev/null; then
      echo -e "\e[91m‚úÖ Node is healthy. No restart needed.\e[0m"
    else
      echo -e "\e[91m‚ö†Ô∏è Unhealthy. Restarting via restart_demos_node helper...\e[0m"
      restart_node
    fi
    ;;

  --restart)
    restart_node
    ;;

  *)
    echo -e "\e[91m‚ùå Unknown command: $COMMAND\e[0m"
    echo -e "\e[91mUsage:\e[0m"
    echo -e "\e[91m  logs_demos_node --status\e[0m"
    echo -e "\e[91m  logs_demos_node --logs=100\e[0m"
    echo -e "\e[91m  logs_demos_node --health\e[0m"
    echo -e "\e[91m  logs_demos_node --autorestart\e[0m"
    echo -e "\e[91m  logs_demos_node --restart\e[0m"
    exit 1
    ;;
esac
