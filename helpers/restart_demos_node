#!/bin/bash
# restart_demos_node
# - Temporarily disable/unmask systemd supervision for demos-node (so systemd won't immediately re-start on stop)
# - Stop the node if running
# - Verify NODE_PORT and DB_PORT are free (optionally --force to kill holders)
# - Start the node unit and wait for health
# - Restore systemd enable/daemon state so systemd resumes supervision
set -euo pipefail
IFS=$'\n\t'

SERVICE="demos-node"
UNIT="${SERVICE}.service"
ENV_FILE="/opt/demos-node/.env"

NODE_PORT=53550
DB_PORT=5332
FORCE=false
RETRY=3
SLEEP_BETWEEN=2
HEALTH_TIMEOUT=20
HEALTH_INTERVAL=2

for arg in "$@"; do
  case "$arg" in
    --force) FORCE=true ;;
    *) ;;
  esac
done

log(){ printf "\e[92m%s\e[0m\n" "$*"; }
err(){ printf "\e[91m%s\e[0m\n" "$*"; }

# load env overrides
if [ -f "$ENV_FILE" ]; then
  NODE_PORT=$(grep -m1 "^NODE_PORT=" "$ENV_FILE" | cut -d'=' -f2 || echo "$NODE_PORT")
  DB_PORT=$(grep -m1 "^DB_PORT=" "$ENV_FILE" | cut -d'=' -f2 || echo "$DB_PORT")
fi

ensure_systemd(){
  if ! command -v systemctl >/dev/null 2>&1; then
    err "systemctl not available; aborting"
    exit 1
  fi
}

is_listening(){ ss -tuln | grep -q ":${1} " && return 0 || return 1; }

kill_holders(){
  local port=$1
  if ! command -v lsof >/dev/null 2>&1; then
    err "lsof missing; cannot inspect port ${port}"
    return 1
  fi
  local pids
  pids=$(sudo lsof -ti :"${port}" 2>/dev/null || true)
  if [ -z "$pids" ]; then return 0; fi
  err "Port ${port} held by PID(s): ${pids}"
  if [ "$FORCE" = true ]; then
    err "Killing ${pids}"
    echo "$pids" | xargs -r sudo kill -9 || true
    sleep 1
    return 0
  fi
  return 1
}

wait_for_unit_active(){
  local unit=$1
  local waited=0
  while [ $waited -lt "$HEALTH_TIMEOUT" ]; do
    if systemctl is-active --quiet "$unit"; then return 0; fi
    sleep "$HEALTH_INTERVAL"
    waited=$((waited + HEALTH_INTERVAL))
  done
  return 1
}

tcp_probe(){
  local port=$1
  if command -v timeout >/dev/null 2>&1; then
    timeout 3 bash -c "cat < /dev/null > /dev/tcp/127.0.0.1/${port}" >/dev/null 2>&1 && return 0 || return 1
  else
    is_listening "$port" && return 0 || return 1
  fi
}

# MAIN
ensure_systemd

if ! systemctl list-unit-files --type=service --all | grep -q "^${UNIT}"; then
  err "Unit ${UNIT} not present; aborting"
  exit 1
fi

log "1) Temporarily preventing systemd from auto-restarting ${UNIT}"
# mask prevents systemd from attempting to restart on stop; record previous enable state
PRE_ENABLED=0
if systemctl is-enabled --quiet "${UNIT}" 2>/dev/null; then PRE_ENABLED=1; fi
# ensure the unit is masked so systemd doesn't auto-restart while we operate
sudo systemctl mask "${UNIT}" >/dev/null 2>&1 || true
sudo systemctl daemon-reload >/dev/null 2>&1 || true

log "2) Stop the node unit if active"
if systemctl is-active --quiet "${UNIT}"; then
  sudo systemctl stop "${UNIT}" || true
  sleep 1
  log "Stopped ${UNIT}"
else
  log "${UNIT} not active"
fi

log "3) Ensure NODE_PORT=${NODE_PORT} is free"
if is_listening "${NODE_PORT}"; then
  err "Node port ${NODE_PORT} still in use"
  if [ "$FORCE" = true ]; then
    kill_holders "${NODE_PORT}" || { err "Could not kill node port holders"; sudo systemctl unmask "${UNIT}" >/dev/null 2>&1 || true; exit 1; }
    log "Node port freed via --force"
  else
    err "Rerun with --force to kill holders or free manually"
    sudo systemctl unmask "${UNIT}" >/dev/null 2>&1 || true
    exit 1
  fi
else
  log "Node port free"
fi

log "4) Ensure DB_PORT=${DB_PORT} is free"
# try to stop system postgres service first (if present) so it doesn't re-bind when we stop node
if systemctl list-unit-files --type=service --all | grep -q '^postgresql'; then
  if systemctl is-active --quiet postgresql; then
    log "Stopping system postgresql to avoid it binding DB_PORT during node restart"
    sudo systemctl stop postgresql >/dev/null 2>&1 || true
    sleep 1
  fi
fi

if is_listening "${DB_PORT}"; then
  err "DB port ${DB_PORT} still in use"
  if [ "$FORCE" = true ]; then
    kill_holders "${DB_PORT}" || { err "Could not kill DB port holders"; sudo systemctl unmask "${UNIT}" >/dev/null 2>&1 || true; exit 1; }
    log "DB port freed via --force"
  else
    err "Rerun with --force to kill holders or free manually"
    sudo systemctl unmask "${UNIT}" >/dev/null 2>&1 || true
    exit 1
  fi
else
  log "DB port free"
fi

log "5) Start the node unit (systemd will be unmasked to allow start)"
# unmask to allow start, but keep disabled state (we will restore enablement later)
sudo systemctl unmask "${UNIT}" >/dev/null 2>&1 || true
sudo systemctl daemon-reload >/dev/null 2>&1 || true
sudo systemctl start "${UNIT}" || { err "systemd start failed"; sudo systemctl mask "${UNIT}" >/dev/null 2>&1 || true; exit 1; }

# wait for active and tcp
if ! wait_for_unit_active "${UNIT}"; then
  err "${UNIT} did not become active within timeout"
  # try to capture logs, restore mask state and exit
  journalctl -u "${UNIT}" --no-pager -n 120 || true
  # re-mask to return to pre-op state
  sudo systemctl mask "${UNIT}" >/dev/null 2>&1 || true
  # restore postgres if we stopped it earlier
  if systemctl list-unit-files --type=service --all | grep -q '^postgresql'; then
    sudo systemctl enable --now postgresql >/dev/null 2>&1 || true
  fi
  exit 1
fi

# quick TCP probe
if ! tcp_probe "${NODE_PORT}"; then
  err "Node not responding on TCP port ${NODE_PORT} after start"
  journalctl -u "${UNIT}" --no-pager -n 120 || true
  sudo systemctl mask "${UNIT}" >/dev/null 2>&1 || true
  if systemctl list-unit-files --type=service --all | grep -q '^postgresql'; then
    sudo systemctl enable --now postgresql >/dev/null 2>&1 || true
  fi
  exit 1
fi

log "Node started and responsive on ${NODE_PORT}"

log "6) Restore systemd supervision as it was before the operation"
if [ "${PRE_ENABLED}" -eq 1 ]; then
  log "Re-enabling and ensuring ${UNIT} is active under systemd"
  sudo systemctl enable --now "${UNIT}" >/dev/null 2>&1 || true
else
  log "Leaving ${UNIT} disabled but unmasked (systemd won't auto-start unless enabled)"
  # ensure the unit is enabled state remains disabled, but unmasked
  sudo systemctl disable "${UNIT}" >/dev/null 2>&1 || true
fi

# Finally, re-enable system postgres if we stopped it earlier (best-effort)
if systemctl list-unit-files --type=service --all | grep -q '^postgresql'; then
  sudo systemctl enable --now postgresql >/dev/null 2>&1 || true
fi

log "Restart procedure complete"
exit 0
