#!/usr/bin/env bash
# restart_demos_node.sh
#
# Purpose:
#   - Cleanly stop the node (systemd-managed or stray).
#   - Disable/mask the systemd unit (but do not delete the unit file).
#   - Stop/remove Postgres Docker container(s) publishing DB_PORT.
#   - Ensure Bun dependencies are installed (requires package.json).
#   - Restart node under systemd and wait for it to bind NODE_PORT.
#   - Wait for node-created Postgres container and set restart policy.
#   - Re-enable systemd unit for autostart on future boots.
#
# Notes:
#   - All user-facing output is printed in RED for consistency.
#   - Script is idempotent: safe to run multiple times.
#   - Run with sudo/root privileges.

set -euo pipefail
IFS=$'\n\t'

# -----------------------------
# Configuration variables
# -----------------------------
UNIT="demos-node.service"                    # Name of the systemd unit
UNIT_PATH="/etc/systemd/system/${UNIT}"      # Path to the unit file
WORKDIR="/opt/demos-node"                    # Node working directory
DB_NAME_FILTER="postgres_5332"               # Docker container name filter
DB_PORT=5332                                 # Postgres host port
NODE_PORT=53550                              # Node RPC port
WAIT_STOP=20                                 # Seconds to wait for processes to stop
WAIT_BIND=40                                 # Seconds to wait for node to bind
WAIT_DB=60                                   # Seconds to wait for DB container

# -----------------------------
# Helper functions
# -----------------------------
msg(){  printf "\e[31m%s\e[0m\n" "$*"; }     # Print normal messages in RED
warn(){ printf "\e[31m%s\e[0m\n" "$*"; }     # Print warnings in RED
err(){  printf "\e[31m%s\e[0m\n" "$*" >&2; } # Print errors in RED to stderr

# Root check
if [ "$(id -u)" -ne 0 ]; then
  err "❌ Run this script as root (sudo)."
  exit 1
fi

# Detect DB containers publishing DB_PORT
detect_db_cids(){
  command -v docker >/dev/null 2>&1 || return 1
  docker ps --format '{{.ID}}\t{{.Ports}}\t{{.Names}}' | awk -v p=":${DB_PORT}->" '$0 ~ p { print $1 }'
}

# -----------------------------
# 1) STOP / CLEAN
# -----------------------------
msg "STEP 1: Stopping node and cleaning systemd + Docker autostart"

# Stop systemd unit if present
if systemctl list-unit-files --type=service --all | grep -q "^${UNIT}"; then
  if systemctl is-active --quiet "${UNIT}"; then
    msg "Stopping systemd unit ${UNIT}..."
    systemctl stop "${UNIT}" || msg "⚠️ systemctl stop returned non-zero; continuing"
  else
    msg "Systemd unit ${UNIT} not active."
  fi

  msg "Masking and disabling ${UNIT} to prevent automatic restarts"
  systemctl mask "${UNIT}" >/dev/null 2>&1 || true
  systemctl disable "${UNIT}" >/dev/null 2>&1 || true
else
  msg "Systemd unit ${UNIT} not present."
fi

# Kill stray node processes (bun or run script)
msg "Killing stray node processes (if any)..."
STRAY_PIDS="$(pgrep -f '/opt/demos-node/run' || true)"
if [ -n "$STRAY_PIDS" ]; then
  echo "$STRAY_PIDS" | while read -r p; do
    msg "  - TERM $p"
    kill -TERM "$p" 2>/dev/null || true
  done
  sleep 2
  echo "$STRAY_PIDS" | while read -r p; do
    if kill -0 "$p" 2>/dev/null; then
      msg "⚠️ PID $p still alive; KILLing"
      kill -KILL "$p" 2>/dev/null || true
    fi
  done
else
  msg "No stray node processes found."
fi

# Stop/remove DB containers
CIDS="$(detect_db_cids || true)"
if [ -n "$CIDS" ]; then
  msg "Found container(s) publishing host port ${DB_PORT}:"
  echo "$CIDS" | while read -r cid; do
    msg "  - ${cid} : set restart=no, stop and remove"
    docker update --restart=no "$cid" >/dev/null 2>&1 || msg "⚠️ docker update failed for $cid"
    docker stop --time 10 "$cid" >/dev/null 2>&1 || msg "⚠️ docker stop failed for $cid"
    docker rm -f "$cid" >/dev/null 2>&1 || msg "⚠️ docker rm failed for $cid"
  done
else
  msg "No container publishing host port ${DB_PORT} detected; skipping container stop/removal."
fi

# -----------------------------
# 2) Ensure dependencies and restart node under systemd
# -----------------------------
msg "STEP 2: Ensuring dependencies and restarting node under systemd"

# Verify package.json exists
if [ ! -f "${WORKDIR}/package.json" ]; then
  err "❌ Missing package.json in ${WORKDIR}. Cannot install dependencies or start node."
  exit 5
fi

# Run bun install
msg "Running bun install in ${WORKDIR}..."
cd "${WORKDIR}"
bun install || { err "❌ bun install failed"; exit 6; }

# Restart systemd unit
msg "Restarting systemd unit ${UNIT}..."
systemctl unmask "${UNIT}" >/dev/null 2>&1 || true
systemctl daemon-reload
systemctl restart "${UNIT}"

# Wait for bind
msg "Waiting up to ${WAIT_BIND}s for node to bind ${NODE_PORT}..."
for i in $(seq 1 ${WAIT_BIND}); do
  if ss -ltnp | grep -q ":${NODE_PORT}"; then
    msg "✅ Node is listening on ${NODE_PORT}."
    break
  fi
  sleep 1
done

if ! ss -ltnp | grep -q ":${NODE_PORT}"; then
  err "❌ Node did not bind ${NODE_PORT} within ${WAIT_BIND}s. Check /var/log/demos-node.out"
  exit 7
fi

# -----------------------------
# 3) Wait for Postgres container and set restart policy
# -----------------------------
msg "STEP 3: Waiting for Postgres container (created by node) and setting restart policy"

CIDS=""
for i in $(seq 1 ${WAIT_DB}); do
  CIDS="$(docker ps --filter name="${DB_NAME_FILTER}" --format '{{.ID}}' || true)"
  if [ -n "${CIDS}" ]; then
    msg "Found Postgres container(s):"
    echo "${CIDS}" | while read -r cid; do msg "  - ${cid}"; done
    break
  fi
  sleep 1
done

if [ -z "${CIDS}" ]; then
  msg "⚠️ No Postgres container detected after ${WAIT_DB}s. The node may create it later."
else
  msg "Setting Docker restart policy to unless-stopped for Postgres container(s)."
  echo "${CIDS}" | while read -r cid; do
    docker update --restart=unless-stopped "${cid}" >/dev/null 2>&1 || msg "⚠️ docker update failed for ${cid}"
    msg "  - restart policy set for ${cid}"
  done
fi

# -----------------------------
# 4) Re-enable systemd unit for future boots
# -----------------------------
msg "STEP 4: Re-enabling systemd unit for future boots"
systemctl enable "${UNIT}" >/dev/null 2>&1 || msg "⚠️ systemctl enable returned non-zero"

msg "✅ Systemd unit ${UNIT} is enabled for autostart on boot."

# -----------------------------
# 5) Final summary
# -----------------------------
msg "RESTART SEQUENCE COMPLETE"
msg "✅ Node is running now under systemd."
if [ -n "${CIDS}" ]; then
  msg "✅ Postgres container(s) are present and configured to restart unless-stopped."
else
  msg "⚠️ Postgres container not detected; node may create it later."
fi

exit 0
