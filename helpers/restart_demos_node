#!/bin/bash
# This helper script restarts the Demos Node systemd service.
# It ensures the node is restarted cleanly and confirms the new status.

set -u
IFS=$'\n\t'

SERVICE_NAME="demos-node"
UNIT_NAME="${SERVICE_NAME}.service"

echo -e "\e[91müîÑ Restarting Demos Node service: $UNIT_NAME\e[0m"

# === Check if systemd is available ===
if ! command -v systemctl &>/dev/null; then
  echo -e "\e[91m‚ùå systemctl not found. This system may not support systemd.\e[0m"
  exit 1
fi

# === Check if service exists ===
if ! systemctl show "$UNIT_NAME" &>/dev/null; then
  echo -e "\e[91m‚ùå Service $UNIT_NAME not found.\e[0m"
  echo -e "\e[91mMake sure the node was installed and the service was created.\e[0m"
  exit 1
fi

# === Restart the service ===
echo -e "\e[91müîß Restarting service...\e[0m"
if systemctl restart "$UNIT_NAME"; then
  echo -e "\e[91m‚úÖ Service restart command issued.\e[0m"
else
  echo -e "\e[91m‚ùå Failed to restart service.\e[0m"
  echo -e "\e[91mTry manually:\e[0m"
  echo -e "\e[91msudo systemctl restart $UNIT_NAME\e[0m"
  exit 1
fi

# === Confirm new status ===
sleep 2
STATUS=$(systemctl is-active "$UNIT_NAME")
PID=$(systemctl show -p MainPID "$UNIT_NAME" | cut -d= -f2 || echo 0)
PID=${PID:-0}

if [ "$STATUS" = "active" ]; then
  echo -e "\e[91m‚úÖ Demos Node is running.\e[0m"
  echo -e "\e[91müß¨ Main PID after restart: $PID\e[0m"
else
  echo -e "\e[91m‚ö†Ô∏è Service restarted but is not active. Status: $STATUS\e[0m"
  echo -e "\e[91mRecent logs:\e[0m"
  journalctl -u "$UNIT_NAME" --no-pager -n 20
  echo -e "\e[91müëâ Check logs above for errors and try:\e[0m"
  echo -e "\e[91msudo systemctl restart $UNIT_NAME\e[0m"
  exit 1
fi
