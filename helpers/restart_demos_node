#!/bin/bash
# restart_demos_node (simplified)
# - Stop DB container (prefer docker compose stop when available) without persisting state
# - Temporarily disable container restart before stopping to reduce race
# - Stop/unmask/start the demos-node systemd unit and wait for it to be responsive
set -euo pipefail
IFS=$'\n\t'

SERVICE="demos-node"
UNIT="${SERVICE}.service"
ENV_FILE="/opt/demos-node/.env"

NODE_PORT=53550
DB_PORT=5332
FORCE=false
HEALTH_TIMEOUT=20
HEALTH_INTERVAL=2

for arg in "$@"; do
  case "$arg" in
    --force) FORCE=true ;;
    *) ;;
  esac
done

log(){ printf "\e[92m%s\e[0m\n" "$*"; }
err(){ printf "\e[91m%s\e[0m\n" "$*" >&2; }

# load env overrides
if [ -f "$ENV_FILE" ]; then
  NODE_PORT=$(grep -m1 "^NODE_PORT=" "$ENV_FILE" | cut -d'=' -f2 || echo "$NODE_PORT")
  DB_PORT=$(grep -m1 "^DB_PORT=" "$ENV_FILE" | cut -d'=' -f2 || echo "$DB_PORT")
fi

is_listening(){ ss -tuln | grep -q ":${1} " && return 0 || return 1; }

wait_for_unit_active(){
  local unit=$1 waited=0
  while [ $waited -lt "$HEALTH_TIMEOUT" ]; do
    if systemctl is-active --quiet "$unit"; then return 0; fi
    sleep "$HEALTH_INTERVAL"
    waited=$((waited + HEALTH_INTERVAL))
  done
  return 1
}

tcp_probe(){
  local port=$1
  if command -v timeout >/dev/null 2>&1; then
    timeout 3 bash -c "cat < /dev/null > /dev/tcp/127.0.0.1/${port}" >/dev/null 2>&1 && return 0 || return 1
  else
    is_listening "$port" && return 0 || return 1
  fi
}

detect_docker_container_publishing_port(){
  local port=$1
  if ! command -v docker >/dev/null 2>&1; then
    echo ""
    return 0
  fi
  docker ps --format '{{.ID}}\t{{.Names}}\t{{.Ports}}' | awk -v p=":${port}->" '$0 ~ p { print $1; exit }'
}

# BEGIN
if ! command -v systemctl >/dev/null 2>&1; then
  err "systemctl not available; aborting"
  exit 1
fi

if ! systemctl list-unit-files --type=service --all | grep -q "^${UNIT}"; then
  err "Unit ${UNIT} not present; aborting"
  exit 1
fi

log "1) Masking ${UNIT} to prevent automatic restarts while we operate"
PRE_ENABLED=0
if systemctl is-enabled --quiet "${UNIT}" 2>/dev/null; then PRE_ENABLED=1; fi
sudo systemctl mask "${UNIT}" >/dev/null 2>&1 || true
sudo systemctl daemon-reload >/dev/null 2>&1 || true

# detect container publishing DB_PORT
CID=$(detect_docker_container_publishing_port "${DB_PORT}" || true)
if [ -n "${CID}" ]; then
  log "Detected container ${CID} publishing host port ${DB_PORT}"

  # try to detect compose labels
  PROJECT=$(docker inspect --format '{{ index .Config.Labels "com.docker.compose.project" }}' "${CID}" 2>/dev/null || true)
  SERVICE_LABEL=$(docker inspect --format '{{ index .Config.Labels "com.docker.compose.service" }}' "${CID}" 2>/dev/null || true)

  if [ -n "$PROJECT" ] && [ -n "$SERVICE_LABEL" ] && command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1 2>/dev/null; then
    log "Stopping compose service ${SERVICE_LABEL} in project ${PROJECT}"
    sudo docker compose -p "${PROJECT}" stop "${SERVICE_LABEL}" >/dev/null 2>&1 || true
  elif [ -n "$PROJECT" ] && [ -n "$SERVICE_LABEL" ] && command -v docker-compose >/dev/null 2>&1; then
    log "Stopping compose service ${SERVICE_LABEL} in project ${PROJECT} (docker-compose)"
    sudo docker-compose -p "${PROJECT}" stop "${SERVICE_LABEL}" >/dev/null 2>&1 || true
  else
    log "Disabling container restart and stopping container ${CID}"
    sudo docker update --restart=no "${CID}" >/dev/null 2>&1 || true
    sudo docker stop --time 10 "${CID}" >/dev/null 2>&1 || {
      err "docker stop failed for ${CID}; proceeding but container may still bind port"
    }
  fi
  sleep 1
else
  log "No DB container found publishing port ${DB_PORT}"
fi

log "2) Stop the node unit if active"
if systemctl is-active --quiet "${UNIT}"; then
  sudo systemctl stop "${UNIT}" || true
  sleep 1
  log "Stopped ${UNIT}"
else
  log "${UNIT} not active"
fi

log "3) Ensure NODE_PORT=${NODE_PORT} is free"
if is_listening "${NODE_PORT}"; then
  err "Node port ${NODE_PORT} still in use"
  if [ "$FORCE" = true ]; then
    err "Force: killing holders"
    sudo lsof -ti :"${NODE_PORT}" | xargs -r sudo kill -9 || true
  else
    err "Rerun with --force to kill holders or free manually; unmasking unit and aborting"
    sudo systemctl unmask "${UNIT}" >/dev/null 2>&1 || true
    exit 1
  fi
else
  log "Node port free"
fi

log "4) Ensure DB_PORT=${DB_PORT} is free"
if is_listening "${DB_PORT}"; then
  err "DB port ${DB_PORT} still in use after stop"
  if [ "$FORCE" = true ]; then
    err "Force: killing holders"
    sudo lsof -ti :"${DB_PORT}" | xargs -r sudo kill -9 || true
    sleep 1
  else
    err "Rerun with --force to kill holders or free manually; unmasking unit and aborting"
    sudo systemctl unmask "${UNIT}" >/dev/null 2>&1 || true
    exit 1
  fi
else
  log "DB port free"
fi

log "5) Start node unit (unmasking temporarily to allow management)"
sudo systemctl unmask "${UNIT}" >/dev/null 2>&1 || true
sudo systemctl daemon-reload >/dev/null 2>&1 || true
sudo systemctl start "${UNIT}" || {
  err "systemd start failed; re-masking unit and aborting"
  sudo systemctl mask "${UNIT}" >/dev/null 2>&1 || true
  exit 1
}

log "Waiting for ${UNIT} to become active and responsive"
if ! wait_for_unit_active "${UNIT}"; then
  err "${UNIT} did not become active within timeout; re-masking and aborting"
  journalctl -u "${UNIT}" --no-pager -n 160 || true
  sudo systemctl mask "${UNIT}" >/dev/null 2>&1 || true
  exit 1
fi

if ! tcp_probe "${NODE_PORT}"; then
  err "Node not responding on TCP port ${NODE_PORT} after start; re-masking and aborting"
  journalctl -u "${UNIT}" --no-pager -n 160 || true
  sudo systemctl mask "${UNIT}" >/dev/null 2>&1 || true
  exit 1
fi

log "Node started and responsive on ${NODE_PORT}"
log "Note: DB container restart policy is not restored by this simplified helper"
log "6) Restore systemd enablement/state for ${UNIT}"
if [ "${PRE_ENABLED}" -eq 1 ]; then
  log "Re-enabling and ensuring ${UNIT} is active under systemd"
  sudo systemctl enable --now "${UNIT}" >/dev/null 2>&1 || true
else
  log "Leaving ${UNIT} disabled but unmasked"
  sudo systemctl disable "${UNIT}" >/dev/null 2>&1 || true
fi

log "Restart procedure complete"
exit 0
