#!/bin/bash
# Expanded health check for Demos Node systemd service.
# Keeps detailed case handling, fixes URL construction, and adds endpoint fallback.

set -euo pipefail
IFS=$'\n\t'

SERVICE_NAME="demos-node"
UNIT_NAME="${SERVICE_NAME}.service"

# === Load .env variables and build HTTP endpoint ===
ENV_FILE="/opt/demos-node/.env"
NODE_PORT="53550"
BASE_URL="http://127.0.0.1:$NODE_PORT"

if [ -f "$ENV_FILE" ]; then
  NODE_PORT=$(grep -m1 "^NODE_PORT=" "$ENV_FILE" | cut -d'=' -f2 || echo "53550")
  EXPOSED_URL=$(grep -m1 "^EXPOSED_URL=" "$ENV_FILE" | cut -d'=' -f2 || true)
  EXPOSED_IP=$(grep -m1 "^EXPOSED_IP=" "$ENV_FILE" | cut -d'=' -f2 || true)

  if [ -n "$EXPOSED_URL" ]; then
    BASE_URL="$EXPOSED_URL"
    [[ "$BASE_URL" =~ ^http ]] || BASE_URL="http://$BASE_URL"
    if [[ "$BASE_URL" != *":$NODE_PORT"* ]]; then
      BASE_URL="${BASE_URL%/}:$NODE_PORT"
    fi
  elif [ -n "$EXPOSED_IP" ]; then
    if [[ "$EXPOSED_IP" == *:* ]]; then
      BASE_URL="http://[$EXPOSED_IP]:$NODE_PORT"
    else
      BASE_URL="http://$EXPOSED_IP:$NODE_PORT"
    fi
  else
    BASE_URL="http://127.0.0.1:$NODE_PORT"
  fi
fi

# Normalize any accidental double colons
BASE_URL=$(echo "$BASE_URL" | sed -E 's/:+/:/g')

echo -e "\e[91müîç Starting full health check for Demos Node service: $SERVICE_NAME\e[0m"

# === Pre-checks ===
if ! command -v systemctl &>/dev/null; then
  echo -e "\e[91m‚ùå systemctl not found. This system may not support systemd.\e[0m"
  exit 1
fi

if ! command -v journalctl &>/dev/null; then
  echo -e "\e[91m‚ùå journalctl not found. Cannot display logs.\e[0m"
  exit 1
fi

if ! systemctl show "$UNIT_NAME" &>/dev/null; then
  echo -e "\e[91m‚ùå Service $UNIT_NAME not found.\e[0m"
  echo -e "\e[91mMake sure the node was installed and the service was created.\e[0m"
  echo -e "\e[91mTry:\e[0m"
  echo -e "\e[91msudo systemctl daemon-reload && sudo systemctl enable $UNIT_NAME && sudo systemctl start $UNIT_NAME\e[0m"
  exit 1
fi

# === Get systemd status and PID ===
STATUS=$(systemctl is-active "$UNIT_NAME")
PID=$(systemctl show -p MainPID "$UNIT_NAME" | cut -d= -f2 || echo 0)
PID=${PID:-0}

echo -e "\e[91müß† Systemd Status: $STATUS\e[0m"
case "$STATUS" in
  active)
    echo -e "\e[91m‚úÖ The service is running normally.\e[0m"
    ;;
  inactive)
    echo -e "\e[91m‚ö†Ô∏è The service is installed but not running.\e[0m"
    echo -e "\e[91mYou can start it with:\e[0m"
    echo -e "\e[91msudo systemctl start $UNIT_NAME\e[0m"
    ;;
  failed)
    echo -e "\e[91m‚ùå The service has crashed or failed to start.\e[0m"
    echo -e "\e[91mRecent logs:\e[0m"
    journalctl -u "$UNIT_NAME" --no-pager -n 20
    echo -e "\e[91mYou can try restarting it:\e[0m"
    echo -e "\e[91msudo systemctl restart $UNIT_NAME\e[0m"
    ;;
  activating)
    echo -e "\e[91m‚è≥ The service is in the process of starting.\e[0m"
    ;;
  deactivating)
    echo -e "\e[91m‚è∏Ô∏è The service is shutting down.\e[0m"
    ;;
  *)
    echo -e "\e[91m‚ùì Unknown status: $STATUS\e[0m"
    ;;
esac

# === PID check ===
if [[ "$PID" =~ ^[0-9]+$ ]] && [ "$PID" -gt 0 ]; then
  echo -e "\e[91müß¨ Main PID: $PID\e[0m"
  echo -e "\e[91m‚úÖ The process is alive and tracked by systemd.\e[0m"
else
  echo -e "\e[91m‚ö†Ô∏è No active process found. The service may be stopped or failed.\e[0m"
fi

# === HTTP endpoint check with fallback ===
ENDPOINTS=( "/health" "/status" "/metrics" )
RESPONSIVE=false

for ep in "${ENDPOINTS[@]}"; do
  HTTP_ENDPOINT="${BASE_URL%/}$ep"
  echo -e "\e[91müåê Checking HTTP endpoint: $HTTP_ENDPOINT\e[0m"
  if curl -fs --max-time 5 "$HTTP_ENDPOINT" &>/dev/null; then
    echo -e "\e[91m‚úÖ Endpoint $ep is responsive.\e[0m"
    RESPONSIVE=true
    break
  else
    echo -e "\e[91m‚ö†Ô∏è Endpoint $ep did not respond.\e[0m"
  fi
done

if [ "$RESPONSIVE" = false ]; then
  echo -e "\e[91m‚ùå No known endpoint responded.\e[0m"
  echo -e "\e[91mThis may indicate the node is running but not serving traffic.\e[0m"
  echo -e "\e[91mRecent logs:\e[0m"
  journalctl -u "$UNIT_NAME" --no-pager -n 40
fi
