#!/bin/bash
# This helper script performs a detailed health check on the Demos Node systemd service.
# It explains the current status, PID, and optionally checks the HTTP endpoint.

set -euo pipefail
IFS=$'\n\t'

SERVICE_NAME="demos-node"
UNIT_NAME="${SERVICE_NAME}.service"
HTTP_ENDPOINT="http://localhost:8080/health"  # Optional: adjust if your node exposes a health route

echo -e "\e[91müîç Starting full health check for Demos Node service: $SERVICE_NAME\e[0m"

# === Check for systemd ===
if ! command -v systemctl &>/dev/null; then
  echo -e "\e[91m‚ùå systemctl not found. This system may not support systemd.\e[0m"
  exit 1
fi

# === Check for journalctl ===
if ! command -v journalctl &>/dev/null; then
  echo -e "\e[91m‚ùå journalctl not found. Cannot display logs.\e[0m"
  exit 1
fi

# === Check if service exists ===
if ! systemctl status "$UNIT_NAME" &>/dev/null; then
  echo -e "\e[91m‚ùå Service $UNIT_NAME not found.\e[0m"
  echo -e "\e[91mMake sure the node was installed and the service was created.\e[0m"
  echo -e "\e[91mTry:\e[0m"
  echo -e "\e[91msudo systemctl daemon-reload && sudo systemctl enable $UNIT_NAME && sudo systemctl start $UNIT_NAME\e[0m"
  exit 1
fi

# === Get systemd status and PID ===
STATUS=$(systemctl is-active "$UNIT_NAME")
PID=$(systemctl show -p MainPID "$UNIT_NAME" | cut -d= -f2 || echo 0)
PID=${PID:-0}

echo -e "\e[91müß† Systemd Status: $STATUS\e[0m"
case "$STATUS" in
  active)
    echo -e "\e[91m‚úÖ The service is running normally.\e[0m"
    ;;
  inactive)
    echo -e "\e[91m‚ö†Ô∏è The service is installed but not running.\e[0m"
    echo -e "\e[91mYou can start it with:\e[0m"
    echo -e "\e[91msudo systemctl start $UNIT_NAME\e[0m"
    ;;
  failed)
    echo -e "\e[91m‚ùå The service has crashed or failed to start.\e[0m"
    echo -e "\e[91mRecent logs:\e[0m"
    journalctl -u "$UNIT_NAME" --no-pager -n 20
    echo -e "\e[91mYou can try restarting it:\e[0m"
    echo -e "\e[91msudo systemctl restart $UNIT_NAME\e[0m"
    ;;
  activating)
    echo -e "\e[91m‚è≥ The service is in the process of starting.\e[0m"
    ;;
  deactivating)
    echo -e "\e[91m‚è∏Ô∏è The service is shutting down.\e[0m"
    ;;
  *)
    echo -e "\e[91m‚ùì Unknown status: $STATUS\e[0m"
    ;;
esac

# === PID check ===
if [[ "$PID" =~ ^[0-9]+$ ]] && [ "$PID" -gt 0 ]; then
  echo -e "\e[91müß¨ Main PID: $PID\e[0m"
  echo -e "\e[91m‚úÖ The process is alive and tracked by systemd.\e[0m"
else
  echo -e "\e[91m‚ö†Ô∏è No active process found. The service may be stopped or failed.\e[0m"
fi

# === Optional HTTP health check ===
echo -e "\e[91müåê Checking HTTP endpoint: $HTTP_ENDPOINT\e[0m"
if curl -fs "$HTTP_ENDPOINT" &>/dev/null; then
  echo -e "\e[91m‚úÖ HTTP endpoint is responsive.\e[0m"
else
  echo -e "\e[91m‚ö†Ô∏è HTTP endpoint is not responding.\e[0m"
  echo -e "\e[91mThis may indicate the node is running but not serving traffic.\e[0m"
  echo -e "\e[91mCheck if the port is correct or if the node exposes a health route.\e[0m"
fi
